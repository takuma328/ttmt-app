<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
    /* === å…¨ä½“ã®è¨­å®š === */
    * { box-sizing: border-box; }
    body {
        font-family: 'Noto Sans JP', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        padding: 20px;
        margin: 0;
        min-height: 100vh;
    }

    /* === ãƒ˜ãƒƒãƒ€ãƒ¼ === */
    .page-header { text-align: center; margin-bottom: 40px; animation: fadeInDown 0.6s ease-out; }
    h2 { color: white; font-size: 2.5rem; font-weight: 900; margin: 0; text-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .subtitle { color: rgba(255,255,255,0.9); font-size: 1rem; margin-top: 8px; font-weight: 400; }

    /* === ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚³ãƒ³ãƒ†ãƒŠ === */
    .tournament-container {
        background: white;
        padding: 50px 30px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow-x: auto;
        animation: fadeInUp 0.8s ease-out;
    }
    .tournament { display: flex; flex-direction: row; gap: 80px; padding-bottom: 30px; min-width: max-content; position: relative; }

    /* SVGæ¥ç¶šç·šç”¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    .connector-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
    }

    .connector-line {
        fill: none;
        stroke: #cbd5e0; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
        stroke-width: 3px; /* å°‘ã—å¤ªã */
        stroke-linecap: square; /* ç«¯ã‚’å››è§’ã */
        stroke-linejoin: miter; /* è§’ã‚’é‹­ã */
        transition: stroke 0.3s, stroke-width 0.3s;
    }
    
    /* â˜…â˜…â˜… å‹è€…ãƒ«ãƒ¼ãƒˆã®èµ¤ç·šï¼ˆã‚«ã‚¯ã‚«ã‚¯å¤ªç·šï¼‰ â˜…â˜…â˜… */
    .connector-line.active {
        stroke: #e91e63; /* æ¿ƒã„ãƒ”ãƒ³ã‚¯ */
        stroke-width: 5px; /* ã‚¬ãƒƒãƒ„ãƒªå¤ªã */
        /* filter: drop-shadow(...) ã¯å‰Šé™¤ */
    }

    /* === ãƒ©ã‚¦ãƒ³ãƒ‰åˆ— === */
    .round { display: flex; flex-direction: column; min-width: 280px; position: relative; z-index: 1; }
    .round-title {
        text-align: center; font-weight: 700; font-size: 1.1rem; color: #667eea; margin-bottom: 30px;
        padding: 12px 24px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 30px; text-transform: uppercase; letter-spacing: 2px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    .matches-list { display: flex; flex-direction: column; justify-content: space-around; flex-grow: 1; gap: 40px; }

    /* === è©¦åˆã‚«ãƒ¼ãƒ‰ === */
    .match {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid transparent; border-radius: 16px; padding: 0; position: relative;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }
    .match:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 16px 48px rgba(102, 126, 234, 0.25); border-color: #667eea; }

    .match-label {
        font-size: 0.7rem; color: #999; font-weight: 600; padding: 12px 16px 8px;
        letter-spacing: 1px; text-transform: uppercase;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    .player {
        padding: 16px 20px; border-bottom: 1px solid #e8ecef; font-size: 1rem; font-weight: 500;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative;
    }
    .player:last-child { border-bottom: none; }
    .winner {
        font-weight: 700; color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
        border-left: 4px solid #667eea;
    }
    .winner::after {
        content: "ğŸ†"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        font-size: 1.2rem; animation: trophy 2s infinite;
    }
    @keyframes trophy { 0%, 100% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } }

    /* â˜…â˜…â˜… è©³ç´°ã‚¹ã‚³ã‚¢è¡¨ç¤º â˜…â˜…â˜… */
    .score-detail {
        font-size: 0.8rem;
        color: #555;
        background-color: #f9f9f9;
        padding: 8px 16px;
        border-top: 1px dashed #e0e0e0;
        white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
        line-height: 1.4;
        text-align: right;
        font-family: monospace; /* æ•°å­—ã‚’æƒãˆã‚‹ãŸã‚ */
    }

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .back-btn-container { text-align: center; margin-top: 40px; animation: fadeInUp 1s ease-out; }
    .back-btn {
        display: inline-block; padding: 16px 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; text-decoration: none; border-radius: 50px; font-weight: 700;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); transition: all 0.3s;
    }
    .back-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 36px rgba(102, 126, 234, 0.5); }

    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="page-header">
    <h2 th:text="${event.name} + ' ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ'"></h2>
    <p class="subtitle">Tournament Bracket</p>
</div>

<div class="tournament-container">
    <div class="tournament" id="tournament">
        <svg class="connector-layer" id="connectorSvg"></svg>
        
        <div class="round" th:each="roundEntry : ${roundMap}">
            <div class="round-title" th:text="'Round ' + ${roundEntry.key}"></div>

            <div class="matches-list">
                <div class="match" th:each="m : ${roundEntry.value}" 
                     th:attr="data-winner=${m.winner}">
                     
                    <div class="match-label">
                        <span th:text="'Match ' + ${m.matchNo}">Match 1</span>
                        
                        <a th:href="@{'/organizer/events/' + ${event.id} + '/matches/' + ${m.id} + '/edit'}" 
                           style="text-decoration: none; background: #eee; color: #333; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; margin-left: 8px;">
                           âœï¸ å…¥åŠ›
                        </a>
                    </div>

                    <div class="player" th:classappend="${m.winner != null && m.winner == m.playerA} ? 'winner'">
                        <span th:text="${m.playerA} ?: 'ï¼ˆæœªå®šï¼‰'"></span>
                    </div>

                    <div class="player" th:classappend="${m.winner != null && m.winner == m.playerB} ? 'winner'">
                        <span th:text="${m.playerB} ?: 'ï¼ˆæœªå®šï¼‰'"></span>
                    </div>
                    
                    <div th:if="${m.score}" class="score-detail" th:text="${m.score}">
                        3-1
                        11-9
                        11-8
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function drawConnectors() {
    const svg = document.getElementById('connectorSvg');
    const tournament = document.getElementById('tournament');
    const rounds = tournament.querySelectorAll('.round');
    
    svg.innerHTML = '';
    
    // SVGã‚µã‚¤ã‚º
    svg.setAttribute('width', tournament.scrollWidth);
    svg.setAttribute('height', tournament.scrollHeight);
    const tournamentRect = tournament.getBoundingClientRect();
    
    rounds.forEach((round, roundIndex) => {
        if (roundIndex === rounds.length - 1) return;
        
        const matches = round.querySelectorAll('.match');
        const nextRound = rounds[roundIndex + 1];
        const nextMatches = nextRound.querySelectorAll('.match');
        
        // 2è©¦åˆã”ã¨ã«æ¬¡ã®1è©¦åˆã¸æ¥ç¶š
        for (let i = 0; i < matches.length; i += 2) {
            const match1 = matches[i];     // ä¸Šã®è©¦åˆ
            const match2 = matches[i + 1]; // ä¸‹ã®è©¦åˆ
            const nextMatch = nextMatches[Math.floor(i / 2)];
            
            if (!match1 || !nextMatch) continue;
            
            const rect1 = match1.getBoundingClientRect();
            const rect2 = match2 ? match2.getBoundingClientRect() : rect1;
            const rectNext = nextMatch.getBoundingClientRect();
            
            // ç›¸å¯¾åº§æ¨™
            const x1 = rect1.right - tournamentRect.left;
            const y1 = rect1.top + rect1.height / 2 - tournamentRect.top;
            const x2 = rect2.right - tournamentRect.left;
            const y2 = rect2.top + rect2.height / 2 - tournamentRect.top;
            const xNext = rectNext.left - tournamentRect.left;
            const yNext = rectNext.top + rectNext.height / 2 - tournamentRect.top;
            
            const xMid = x1 + 40;

            // â˜…å‹è€…åˆ¤å®šâ˜…ï¼ˆJSã§èµ¤ç·šã‚’å¼•ããŸã‚ï¼‰
            // æ¬¡ã®è©¦åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—ï¼ˆPlayerA, PlayerBï¼‰
            const nextPlayers = nextMatch.querySelectorAll('.player span');
            const playerA_next = nextPlayers[0] ? nextPlayers[0].innerText : "";
            const playerB_next = nextPlayers[1] ? nextPlayers[1].innerText : "";

            const winner1 = match1.getAttribute('data-winner');
            const winner2 = match2 ? match2.getAttribute('data-winner') : null;

            // ç·šã‚’æãé–¢æ•°
            const drawPath = (d, isActive) => {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('class', isActive ? 'connector-line active' : 'connector-line');
                svg.appendChild(path);
            };

            if (match2) {
                // 1. ä¸Šã®è©¦åˆã‹ã‚‰ã®ç·šï¼ˆå‹è€…ãŒæ¬¡ã®PlayerAã¨åŒã˜åå‰ãªã‚‰èµ¤ãã™ã‚‹ï¼‰
                const isWin1 = winner1 && (winner1 === playerA_next);
                drawPath(`M ${x1} ${y1} L ${xMid} ${y1} L ${xMid} ${(y1+y2)/2}`, isWin1);

                // 2. ä¸‹ã®è©¦åˆã‹ã‚‰ã®ç·šï¼ˆå‹è€…ãŒæ¬¡ã®PlayerBã¨åŒã˜åå‰ãªã‚‰èµ¤ãã™ã‚‹ï¼‰
                // â€»æ¬¡ã®è©¦åˆã®PlayerBã«å…¥ã‚‹ã®ã¯ã€Œå¶æ•°ç•ªç›®ã®è©¦åˆã®å‹è€…ã€ãªã®ã§ã€match2ã®å‹è€…ã¨æ¯”è¼ƒ
                // ãŸã ã—ã€matchNoã«ã‚ˆã£ã¦ã¯é€†ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€å˜ç´”ã«åå‰ä¸€è‡´ã§åˆ¤å®šã™ã‚‹ã®ãŒç¢ºå®Ÿ
                const isWin2 = winner2 && (winner2 === playerB_next || winner2 === playerA_next); 
                drawPath(`M ${x2} ${y2} L ${xMid} ${y2} L ${xMid} ${(y1+y2)/2}`, isWin2);

                // 3. åˆæµã—ã¦æ¬¡ã¸è¡Œãç·š
                drawPath(`M ${xMid} ${(y1+y2)/2} L ${xNext} ${yNext}`, isWin1 || isWin2);
            } else {
                // ç›´ç·šï¼ˆã‚·ãƒ¼ãƒ‰ãªã©ï¼‰
                const isWin1 = winner1 && (winner1 === playerA_next);
                drawPath(`M ${x1} ${y1} L ${xNext} ${yNext}`, isWin1);
            }
        }
    });
}

window.addEventListener('load', drawConnectors);
window.addEventListener('resize', drawConnectors);
document.getElementById('tournament').addEventListener('scroll', drawConnectors);
</script>

<div class="back-btn-container">
    <a th:href="@{'/organizer/events/' + ${event.id} + '/detail'}" class="back-btn">è©³ç´°ç”»é¢ã¸æˆ»ã‚‹</a>
</div>

</body>
</html>